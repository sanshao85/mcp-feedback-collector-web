<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ MCP Feedback Collector - WebÁâà</title>
    <style>
        /* VS Code È£éÊ†ºÁöÑÊ∑±Ëâ≤‰∏ªÈ¢ò */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            font-size: 13px;
            line-height: 1.5;
            padding: 20px;
        }

        /* ‰∏ªÂÆπÂô® */
        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* È°µÈù¢Ê†áÈ¢ò */
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #969696;
            margin-bottom: 24px;
        }

        /* ËøûÊé•Áä∂ÊÄÅ */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #4ec9b0;
            color: #1e1e1e;
        }

        .connection-status.disconnected {
            background: #f14c4c;
            color: white;
        }

        /* ÂØºËà™Ê†áÁ≠æ */
        .nav-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid #3e3e42;
        }

        .nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #969696;
            font-size: 13px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            color: #cccccc;
        }

        .nav-tab.active {
            color: #ffffff;
            border-bottom-color: #007acc;
        }

        /* Ëé∑ÂèñkeyÈìæÊé• */
        .get-key-link {
            padding: 12px 20px;
            color: #007acc;
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .get-key-link:hover {
            color: #ffffff;
            text-decoration: none;
        }

        /* ÂÜÖÂÆπÂå∫Âüü */
        .content-area {
            display: none;
        }

        .content-area.active {
            display: block;
        }

        /* Â∑•‰ΩúÊ±áÊä•Âç°Áâá */
        .report-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            background: #323233;
            border-bottom: 1px solid #3e3e42;
            color: #ffffff;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            font-size: 12px;
            color: #969696;
        }

        .card-body {
            padding: 16px 20px;
        }

        .feature-list {
            list-style: none;
        }

        .feature-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
            color: #cccccc;
        }

        .feature-item::before {
            content: '‚úì';
            color: #4ec9b0;
            font-weight: bold;
            margin-right: 12px;
            width: 16px;
            text-align: center;
        }

        /* ÂèçÈ¶àË°®ÂçïÂç°Áâá */
        .feedback-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            margin-top: 24px;
            overflow: hidden;
        }

        .feedback-header {
            padding: 16px 20px;
            background: #323233;
            border-bottom: 1px solid #3e3e42;
            color: #ffffff;
        }

        .feedback-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-body {
            padding: 20px;
        }

        /* Ë°®ÂçïÂÖÉÁ¥† */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #969696;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background: #1e1e1e;
            color: #cccccc;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #007acc;
        }

        .form-textarea::placeholder {
            color: #6a6a6a;
        }

        /* ÂõæÁâáÈ¢ÑËßàÂå∫Âüü */
        .image-preview-area {
            margin-bottom: 16px;
        }

        .image-previews {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .image-preview {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 4px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            overflow: hidden;
        }

        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e81123;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Â∑•ÂÖ∑Ê†è */
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background: #2d2d30;
            color: #cccccc;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toolbar-btn:hover {
            background: #3c3c3c;
            border-color: #007acc;
        }

        /* ÊåâÈíÆÁªÑ */
        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            border: none;
        }

        .btn-secondary {
            background: transparent;
            color: #969696;
            border: 1px solid #3e3e42;
        }

        .btn-secondary:hover {
            background: #3c3c3c;
        }

        .btn-primary {
            background: #007acc;
            color: white;
            border: 1px solid #007acc;
        }

        .btn-primary:hover {
            background: #005a9e;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Áä∂ÊÄÅÊ∂àÊÅØ */
        .status-message {
            padding: 12px;
            border-radius: 4px;
            margin: 16px 0;
            font-size: 13px;
        }

        .status-message.success {
            background: #4ec9b0;
            color: #1e1e1e;
        }

        .status-message.error {
            background: #f14c4c;
            color: white;
        }

        .status-message.info {
            background: #007acc;
            color: white;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #3e3e42;
            border-radius: 50%;
            border-top-color: #007acc;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ËÅäÂ§©ÁïåÈù¢Ê†∑Âºè */
        .chat-container {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 16px 20px;
            background: #323233;
            border-bottom: 1px solid #3e3e42;
            color: #ffffff;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            display: flex;
            margin-bottom: 16px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: #007acc;
            color: white;
        }

        .message.ai .message-bubble {
            background: #323233;
            color: #cccccc;
            border: 1px solid #3e3e42;
        }

        .message-time {
            text-align: center;
            color: #969696;
            font-size: 12px;
            margin: 16px 0 8px;
        }

        .api-hint {
            background: #323233;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .api-hint-title {
            color: #4ec9b0;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .api-hint-link {
            color: #007acc;
            text-decoration: none;
        }

        .api-hint-desc {
            font-size: 12px;
            color: #969696;
            margin-top: 4px;
        }

        .chat-input-area {
            background: #323233;
            border-top: 1px solid #3e3e42;
            padding: 12px;
        }

        .chat-input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            min-height: 32px;
            max-height: 80px;
            padding: 6px 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background: #1e1e1e;
            color: #cccccc;
            resize: none;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.4;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .chat-actions {
            display: flex;
            gap: 4px;
        }

        .chat-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid #3e3e42;
            background: #2d2d30;
            color: #cccccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .chat-btn:hover {
            background: #3c3c3c;
            border-color: #007acc;
        }

        .send-btn {
            background: #007acc !important;
            border-color: #007acc !important;
            color: white !important;
        }

        .send-btn:hover {
            background: #005a9e !important;
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 14px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 7px;
            border: 3px solid #1e1e1e;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .page-title {
                font-size: 20px;
            }

            .card-header, .feedback-header {
                padding: 12px 16px;
            }

            .card-body, .feedback-body {
                padding: 16px;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ËøûÊé•Áä∂ÊÄÅ -->
        <div id="connection-status" class="connection-status disconnected">
            ËøûÊé•‰∏≠...
        </div>

        <!-- È°µÈù¢Ê†áÈ¢ò -->
        <h1 class="page-title">
            <span>üéØ</span>
            MCP Feedback Collector - WebÁâà
        </h1>
        <p class="page-subtitle">Âü∫‰∫éFlask + WebSocketÁöÑÁé∞‰ª£ÂåñÂèçÈ¶àÊî∂ÈõÜÂô®</p>

        <!-- ÂØºËà™Ê†áÁ≠æ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('report')">üìã Â∑•‰ΩúÊ±áÊä•</button>
            <button class="nav-tab" onclick="switchTab('chat')">üí¨ AIÂØπËØù</button>
            <a href="https://api.ssopen.top" target="_blank" class="get-key-link">üîë Ëé∑Âèñkey</a>
        </div>

        <!-- Áä∂ÊÄÅÊ∂àÊÅØÂå∫Âüü -->
        <div id="status-messages"></div>

        <!-- Â∑•‰ΩúÊ±áÊä•ÂÜÖÂÆπÂå∫Âüü -->
        <div id="report-content" class="content-area active">
            <!-- Âä®ÊÄÅÂ∑•‰ΩúÊ±áÊä•ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            <div id="default-message" class="report-card" style="text-align: center; padding: 40px;">
                <div class="card-body">
                    <div style="color: #969696; font-size: 14px;">
                        <span style="font-size: 24px;">üìã</span>
                        <br><br>
                        Á≠âÂæÖAIÂ∑•‰ΩúÊ±áÊä•...
                        <br><br>
                        <small>ÂΩìAIË∞ÉÁî® collect_feedback() Êó∂ÔºåÂ∑•‰ΩúÊ±áÊä•ÂÜÖÂÆπÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå</small>
                    </div>
                </div>
            </div>

            <!-- ÂèçÈ¶àË°®Âçï -->
            <div class="feedback-card">
                <div class="feedback-header">
                    <div class="feedback-title">
                        <span>üí¨</span>
                        ÊÇ®ÁöÑÂèçÈ¶à
                    </div>
                </div>
                <div class="feedback-body">
                    <form id="feedback-form">
                        <div class="form-group">
                            <label class="form-label">ÂèçÈ¶àÂÜÖÂÆπ</label>
                            <textarea
                                id="feedback-text"
                                class="form-textarea"
                                placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÂØπÊú¨Ê¨°Â∑•‰ΩúÁöÑÂèçÈ¶àÂíåÂª∫ËÆÆ..."
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ÈôÑ‰ª∂ÂõæÁâáÔºàÂèØÈÄâÔºâ</label>
                            <div class="toolbar">
                                <button type="button" class="toolbar-btn" onclick="selectImages()">
                                    üìÅ ÈÄâÊã©ÂõæÁâá
                                </button>
                                <button type="button" class="toolbar-btn" onclick="pasteImages()">
                                    üìã Á≤òË¥¥ÂõæÁâá
                                </button>
                            </div>

                            <div class="image-preview-area">
                                <div class="image-previews" id="image-previews"></div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="clearFeedbackForm()">
                                Ê∏ÖÁ©∫
                            </button>
                            <button type="submit" class="btn btn-primary" id="submit-feedback-btn">
                                Êèê‰∫§ÂèçÈ¶à
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- AIÂØπËØùÂÜÖÂÆπÂå∫Âüü -->
        <div id="chat-content" class="content-area">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">
                        <span>üí¨</span>
                        AI Âä©ÊâãÂØπËØù
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="message-time">‰ªäÂ§©</div>

                    <div class="message ai">
                        <div class="message-bubble">ÊÇ®Â•ΩÔºÅÊàëÊòØAIÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÂä©ÊÇ®ÁöÑÂêóÔºü</div>
                    </div>

                    {% if not api_key_configured %}
                    <div class="api-hint">
                        <div class="api-hint-title">üîë ÈúÄË¶ÅAPIÂØÜÈí•</div>
                        <div>
                            <a href="https://api.ssopen.top/" target="_blank" class="api-hint-link">
                                ÁÇπÂáªËé∑Âèñ SSOpen API ÂØÜÈí•
                            </a>
                        </div>
                        <div class="api-hint-desc">È´òÈÄüÁ®≥ÂÆö | ‰ª∑Ê†º‰ºòÊÉ† | ÂÆâÂÖ®ÂèØÈù†</div>
                    </div>
                    {% endif %}
                </div>

                <div class="chat-input-area">
                    <!-- ËÅäÂ§©ÂõæÁâáÈ¢ÑËßàÂå∫Âüü -->
                    <div id="chat-image-previews" class="image-previews-container" style="display: none;">
                        <div class="image-previews" id="chat-image-previews-content"></div>
                    </div>

                    <div class="chat-input-row">
                        <textarea id="chat-input" class="chat-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." onkeydown="handleChatKeydown(event)"></textarea>
                        <div class="chat-actions">
                            <button class="chat-btn" onclick="selectChatImage()" title="ÈÄâÊã©ÂõæÁâá">üì∑</button>
                            <button class="chat-btn" onclick="pasteChatImage()" title="Á≤òË¥¥ÂõæÁâá">üìã</button>
                            <button class="chat-btn" onclick="clearChat()" title="Ê∏ÖÁ©∫ËÅäÂ§©">üóëÔ∏è</button>
                            <button class="chat-btn send-btn" onclick="sendChatMessage()" title="ÂèëÈÄÅ" id="send-chat-btn">üöÄ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IOÂÆ¢Êà∑Á´Ø -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- ‰∏ªÂ∫îÁî®ËÑöÊú¨ -->
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let socket = null;
        let currentTab = 'report';
        let selectedImages = [];
        let chatImages = [];
        let isConnected = false;
        let currentFeedbackSession = null;

        // AIËÅäÂ§©Áõ∏ÂÖ≥ÂèòÈáè
        let chatConfig = null;
        let chatHistory = [];
        let currentAIMessage = null;
        let currentAIContent = '';
        let isApiCalling = false;

        // Ëé∑ÂèñAPIÈÖçÁΩÆ
        async function loadChatConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    chatConfig = await response.json();
                    console.log('ËÅäÂ§©ÈÖçÁΩÆÂä†ËΩΩÊàêÂäü:', chatConfig);
                    return true;
                } else {
                    console.error('Ëé∑ÂèñÈÖçÁΩÆÂ§±Ë¥•:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÈÖçÁΩÆÊó∂Âá∫Èîô:', error);
                return false;
            }
        }

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', function() {
            // Âä†ËΩΩËÅäÂ§©ÈÖçÁΩÆ
            loadChatConfig();

            initializeSocket();

            // Ê£ÄÊü•URLÂèÇÊï∞
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const session = urlParams.get('session');

            console.log('URLÂèÇÊï∞:', { mode, session });

            if (mode === 'chat') {
                switchTab('chat');
            } else if (mode === 'feedback' && session) {
                // ÂèçÈ¶àÊ®°ÂºèÔºåËÆæÁΩÆ‰ºöËØùIDÂπ∂Ëé∑ÂèñÂ∑•‰ΩúÊ±áÊä•
                currentFeedbackSession = session;
                console.log('ËÆæÁΩÆÂèçÈ¶à‰ºöËØùID:', session);

                // Á≠âÂæÖWebSocketËøûÊé•Âª∫Á´ãÂêéËé∑ÂèñÂ∑•‰ΩúÊ±áÊä•
                setTimeout(() => {
                    if (isConnected && socket) {
                        console.log('ËØ∑Ê±ÇÂ∑•‰ΩúÊ±áÊä•Êï∞ÊçÆ...');
                        socket.emit('get_work_summary', { feedback_session_id: session });
                    } else {
                        console.log('WebSocketÊú™ËøûÊé•ÔºåÁ®çÂêéÈáçËØï...');
                        setTimeout(() => {
                            if (isConnected && socket) {
                                socket.emit('get_work_summary', { feedback_session_id: session });
                            }
                        }, 1000);
                    }
                }, 500);
            } else if (mode === 'pick_image' && session) {
                // ÂõæÁâáÈÄâÊã©Ê®°Âºè
                showImagePickerDialog(session);
            }
        });

        // ÂàùÂßãÂåñWebSocketËøûÊé•
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                isConnected = true;
                updateConnectionStatus('connected', 'Â∑≤ËøûÊé•');
                console.log('WebSocketËøûÊé•ÊàêÂäü');
            });
            
            socket.on('disconnect', function() {
                isConnected = false;
                updateConnectionStatus('disconnected', 'ËøûÊé•Êñ≠ÂºÄ');
                console.log('WebSocketËøûÊé•Êñ≠ÂºÄ');
            });
            
            socket.on('feedback_session_started', function(data) {
                console.log('ÂèçÈ¶à‰ºöËØùÂ∑≤ÂºÄÂßã:', data);
            });
            
            socket.on('feedback_submitted', function(data) {
                showStatusMessage('success', 'ÂèçÈ¶àÊèê‰∫§ÊàêÂäüÔºÅÊÑüË∞¢ÊÇ®ÁöÑÂÆùË¥µÊÑèËßÅ„ÄÇ');
                clearFeedbackForm();
            });
            
            socket.on('feedback_error', function(data) {
                showStatusMessage('error', data.error);
            });
            
            // ËÅäÂ§©ÂäüËÉΩÂ∑≤Êîπ‰∏∫Áõ¥Êé•APIË∞ÉÁî®Ôºå‰∏çÂÜçÈúÄË¶ÅWebSocket‰∫ã‰ª∂

            socket.on('work_summary_data', function(data) {
                console.log('Êî∂Âà∞Â∑•‰ΩúÊ±áÊä•Êï∞ÊçÆ:', data);
                if (data.work_summary) {
                    displayWorkSummary(data.work_summary);
                }
            });

            socket.on('pick_image_success', function(data) {
                console.log('ÂõæÁâáÈÄâÊã©ÊàêÂäü:', data);
                showStatusMessage('success', data.message);

                // ÂÖ≥Èó≠ÂõæÁâáÈÄâÊã©ÂØπËØùÊ°Ü
                setTimeout(() => {
                    cancelImagePicker();
                }, 1000);
            });

            socket.on('pick_image_error', function(data) {
                console.log('ÂõæÁâáÈÄâÊã©Â§±Ë¥•:', data);
                showStatusMessage('error', data.error);

                // ÈáçÊñ∞ÂêØÁî®Á°ÆËÆ§ÊåâÈíÆ
                const confirmBtn = document.getElementById('confirm-image-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = 'Á°ÆËÆ§ÈÄâÊã©';
                    confirmBtn.disabled = false;
                }
            });
        }

        // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `connection-status ${status}`;
            statusEl.textContent = text;
        }

        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
        function showStatusMessage(type, message) {
            const container = document.getElementById('status-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `status-message ${type}`;
            messageEl.textContent = message;
            
            container.appendChild(messageEl);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 3000);
        }

        // ÂàáÊç¢Ê†áÁ≠æ
        function switchTab(tabName) {
            currentTab = tabName;

            // Êõ¥Êñ∞Ê†áÁ≠æÁä∂ÊÄÅ
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // ÊâæÂà∞ÂØπÂ∫îÁöÑÊ†áÁ≠æÊåâÈíÆÂπ∂ÊøÄÊ¥ª
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                if ((tabName === 'report' && tab.textContent.includes('Â∑•‰ΩúÊ±áÊä•')) ||
                    (tabName === 'chat' && tab.textContent.includes('AIÂØπËØù'))) {
                    tab.classList.add('active');
                }
            });

            // Êõ¥Êñ∞ÂÜÖÂÆπÂå∫ÂüüÊòæÁ§∫
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });
            document.getElementById(tabName + '-content').classList.add('active');

            // Ê†πÊçÆÊ†áÁ≠æÂàùÂßãÂåñÁõ∏Â∫îÂäüËÉΩ
            if (tabName === 'chat') {
                // ËÅäÂ§©Ê†áÁ≠æÂ∑≤ÂàáÊç¢‰∏∫Áõ¥Êé•APIË∞ÉÁî®ÔºåÊó†ÈúÄWebSocketÂàùÂßãÂåñ
                console.log('ÂàáÊç¢Âà∞ËÅäÂ§©Ê†áÁ≠æ');
            }
        }

        // ÂèçÈ¶àË°®ÂçïÁõ∏ÂÖ≥ÂäüËÉΩ
        function selectImages() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;

            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        addImage(file);
                    }
                });
            };

            input.click();
        }

        function pasteImages() {
            navigator.clipboard.read().then(items => {
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            item.getType(type).then(blob => {
                                const file = new File([blob], `pasted-image-${Date.now()}.png`, { type: blob.type });
                                addImage(file);
                            });
                        }
                    }
                }
            }).catch(err => {
                console.log('Á≤òË¥¥Â§±Ë¥•:', err);
                showStatusMessage('error', 'Á≤òË¥¥ÂõæÁâáÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÈÄâÊã©Êñá‰ª∂ÊñπÂºè');
            });
        }

        function addImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    file: file,
                    data: e.target.result,
                    name: file.name,
                    id: Date.now() + Math.random()
                };

                selectedImages.push(imageData);
                updateImagePreviews();
            };
            reader.readAsDataURL(file);
        }

        function updateImagePreviews() {
            const container = document.getElementById('image-previews');
            container.innerHTML = '';

            selectedImages.forEach((image, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                previewDiv.innerHTML = `
                    <img src="${image.data}" alt="${image.name}" class="preview-img">
                    <button type="button" class="remove-btn" onclick="removeImage(${index})">√ó</button>
                `;
                container.appendChild(previewDiv);
            });
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreviews();
        }

        function clearFeedbackForm() {
            document.getElementById('feedback-text').value = '';
            selectedImages = [];
            updateImagePreviews();
        }

        // Êèê‰∫§ÂèçÈ¶à
        document.getElementById('feedback-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const feedbackText = document.getElementById('feedback-text').value.trim();

            console.log('Êèê‰∫§ÂèçÈ¶à:', {
                text: feedbackText,
                images: selectedImages.length,
                session: currentFeedbackSession,
                connected: isConnected
            });

            if (!feedbackText && selectedImages.length === 0) {
                showStatusMessage('error', 'ËØ∑ËæìÂÖ•ÂèçÈ¶àÂÜÖÂÆπÊàñÈÄâÊã©ÂõæÁâá');
                return;
            }

            if (!isConnected) {
                showStatusMessage('error', 'ËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }

            // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆ
            const submitBtn = document.getElementById('submit-feedback-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> Êèê‰∫§‰∏≠...';

            // ÂèëÈÄÅÂèçÈ¶àÊï∞ÊçÆ
            const feedbackData = {
                text: feedbackText,
                images: selectedImages.map(img => ({
                    name: img.name,
                    data: img.data
                })),
                feedback_session_id: currentFeedbackSession
            };

            console.log('ÂèëÈÄÅÂèçÈ¶àÊï∞ÊçÆ:', feedbackData);
            socket.emit('submit_feedback', feedbackData);

            // 5ÁßíÂêéÈáçÊñ∞ÂêØÁî®ÊåâÈíÆÔºàÈò≤Ê≠¢Âç°‰ΩèÔºâ
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Êèê‰∫§ÂèçÈ¶à';
            }, 5000);
        });

        // ËÅäÂ§©Áõ∏ÂÖ≥ÂäüËÉΩ
        function selectChatImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;

            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        addChatImage(file);
                    }
                });
            };

            input.click();
        }

        function pasteChatImage() {
            navigator.clipboard.read().then(items => {
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            item.getType(type).then(blob => {
                                const file = new File([blob], `pasted-image-${Date.now()}.png`, { type: blob.type });
                                addChatImage(file);
                            });
                        }
                    }
                }
            }).catch(err => {
                console.log('Á≤òË¥¥Â§±Ë¥•:', err);
                showStatusMessage('error', 'Á≤òË¥¥ÂõæÁâáÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÈÄâÊã©Êñá‰ª∂ÊñπÂºè');
            });
        }

        function addChatImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    file: file,
                    data: e.target.result,
                    name: file.name,
                    id: Date.now() + Math.random()
                };
                chatImages.push(imageData);
                updateChatImagePreviews();
                showStatusMessage('info', `Â∑≤Ê∑ªÂä†ÂõæÁâá: ${file.name}`);
            };
            reader.readAsDataURL(file);
        }

        function updateChatImagePreviews() {
            const container = document.getElementById('chat-image-previews-content');
            const previewArea = document.getElementById('chat-image-previews');

            if (!container || !previewArea) return;

            container.innerHTML = '';

            if (chatImages.length === 0) {
                previewArea.style.display = 'none';
                return;
            }

            previewArea.style.display = 'block';

            chatImages.forEach((image, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                previewDiv.innerHTML = `
                    <img src="${image.data}" alt="${image.name}" class="preview-img">
                    <button type="button" class="remove-btn" onclick="removeChatImage(${index})">√ó</button>
                `;
                container.appendChild(previewDiv);
            });
        }

        function removeChatImage(index) {
            chatImages.splice(index, 1);
            updateChatImagePreviews();
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const messageText = input ? input.value.trim() : '';

            if (!messageText && chatImages.length === 0) {
                return;
            }

            // Ê£ÄÊü•ÈÖçÁΩÆ
            if (!chatConfig || !chatConfig.api_key) {
                showStatusMessage('error', 'APIÈÖçÁΩÆÊú™Âä†ËΩΩÊàñAPIÂØÜÈí•Êú™ËÆæÁΩÆ');
                return;
            }

            if (isApiCalling) {
                showStatusMessage('warning', 'Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂÄô...');
                return;
            }

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÁïåÈù¢
            addMessageToChat('user', messageText, chatImages);

            // Ê∏ÖÁ©∫ËæìÂÖ•
            if (input) input.value = '';
            const currentImages = chatImages.slice();
            chatImages = [];
            updateChatImagePreviews();

            // Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆ
            const sendBtn = document.getElementById('send-chat-btn');
            sendBtn.disabled = true;
            isApiCalling = true;

            // ÂáÜÂ§áÊé•Êî∂AIÂõûÂ§ç
            currentAIContent = '';
            currentAIMessage = addMessageToChat('ai', '', []);

            try {
                await callChatAPI(messageText, currentImages);
            } catch (error) {
                console.error('ËÅäÂ§©APIË∞ÉÁî®Â§±Ë¥•:', error);
                showStatusMessage('error', `ËÅäÂ§©Â§±Ë¥•: ${error.message}`);
            } finally {
                // ÈáçÊñ∞ÂêØÁî®ÂèëÈÄÅÊåâÈíÆ
                sendBtn.disabled = false;
                isApiCalling = false;
            }
        }

        // Áõ¥Êé•Ë∞ÉÁî®ËÅäÂ§©API
        async function callChatAPI(messageText, images) {
            // ÊûÑÂª∫Ê∂àÊÅØÊ†ºÂºè
            const userMessage = buildAPIMessage(messageText, images);

            // Ê∑ªÂä†Âà∞ËÅäÂ§©ÂéÜÂè≤
            chatHistory.push(userMessage);

            // ÊûÑÂª∫APIËØ∑Ê±Ç
            const requestBody = {
                model: chatConfig.model,
                messages: chatHistory,
                stream: true,
                temperature: chatConfig.temperature || 0.7,
                max_tokens: chatConfig.max_tokens || 2000
            };

            console.log('ÂèëÈÄÅAPIËØ∑Ê±Ç:', {
                url: `${chatConfig.api_base_url}/v1/chat/completions`,
                model: requestBody.model,
                messageCount: requestBody.messages.length
            });

            const response = await fetch(`${chatConfig.api_base_url}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${chatConfig.api_key}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`);
            }

            // Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î
            await handleStreamResponse(response);
        }

        // ÊûÑÂª∫APIÊ∂àÊÅØÊ†ºÂºè
        function buildAPIMessage(messageText, images) {
            if (!images || images.length === 0) {
                // Á∫ØÊñáÊú¨Ê∂àÊÅØ
                return { role: "user", content: messageText };
            } else {
                // ÂåÖÂê´ÂõæÁâáÁöÑÊ∂àÊÅØ
                const content = [];

                if (messageText) {
                    content.push({ type: "text", text: messageText });
                }

                images.forEach(img => {
                    let imageData = img.data;
                    // Á°Æ‰øùÊòØÂÆåÊï¥ÁöÑdata URLÊ†ºÂºè
                    if (!imageData.startsWith('data:image/')) {
                        imageData = `data:image/png;base64,${imageData}`;
                    }

                    content.push({
                        type: "image_url",
                        image_url: { url: imageData }
                    });
                });

                return { role: "user", content: content };
            }
        }

        // Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î
        async function handleStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let aiResponseContent = '';

            try {
                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '') continue;

                        if (line.startsWith('data: ')) {
                            const data = line.slice(6); // ÁßªÈô§ 'data: ' ÂâçÁºÄ

                            if (data === '[DONE]') {
                                // ÊµÅÂºèÂìçÂ∫îÁªìÊùü
                                if (aiResponseContent) {
                                    // Â∞ÜAIÂõûÂ§çÊ∑ªÂä†Âà∞ËÅäÂ§©ÂéÜÂè≤
                                    chatHistory.push({
                                        role: "assistant",
                                        content: aiResponseContent
                                    });
                                }
                                console.log('AIÂõûÂ§çÂÆåÊàêÔºåÊÄªÈïøÂ∫¶:', aiResponseContent.length);
                                return;
                            }

                            try {
                                const jsonData = JSON.parse(data);
                                if (jsonData.choices && jsonData.choices[0]) {
                                    const delta = jsonData.choices[0].delta;
                                    if (delta && delta.content) {
                                        aiResponseContent += delta.content;

                                        // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
                                        if (currentAIMessage) {
                                            currentAIMessage.innerHTML = aiResponseContent;

                                            // ÊªöÂä®Âà∞Â∫ïÈÉ®
                                            const chatMessages = document.getElementById('chat-messages');
                                            chatMessages.scrollTop = chatMessages.scrollHeight;
                                        }
                                    }
                                }
                            } catch (e) {
                                // ÂøΩÁï•JSONËß£ÊûêÈîôËØØ
                                console.log('JSONËß£ÊûêÈîôËØØ:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Â§ÑÁêÜÊµÅÂºèÂìçÂ∫îÊó∂Âá∫Èîô:', error);
                throw error;
            } finally {
                reader.releaseLock();
            }
        }

        function addMessageToChat(sender, text, images) {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return null;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            let imageHtml = '';
            if (images && images.length > 0) {
                imageHtml = images.map(img =>
                    `<img src="${img.data}" style="max-width: 200px; max-height: 200px; border-radius: 4px; margin: 4px 0; display: block;">`
                ).join('');
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.innerHTML = `${imageHtml}${text}`;

            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return bubbleDiv; // ËøîÂõûÊ∞îÊ≥°ÂÖÉÁ¥†ÔºåÁî®‰∫éÊõ¥Êñ∞AIÊ∂àÊÅØ
        }

        // handleChatMessageChunkÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÊîπ‰∏∫Áõ¥Êé•APIË∞ÉÁî®Â§ÑÁêÜÊµÅÂºèÂìçÂ∫î

        function clearChat() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü')) {
                // Ê∏ÖÁ©∫ËÅäÂ§©ÂéÜÂè≤
                chatHistory = [];

                // Ê∏ÖÁ©∫ÁïåÈù¢ÊòæÁ§∫
                clearChatMessages();

                showStatusMessage('info', 'ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
            }
        }

        function clearChatMessages() {
            const chatMessages = document.getElementById('chat-messages');
            // ‰øùÁïôÊ¨¢ËøéÊ∂àÊÅØÂíåAPIÊèêÁ§∫
            const children = Array.from(chatMessages.children);
            children.forEach((child, index) => {
                if (index > 2) { // ‰øùÁïôÂâç3‰∏™ÂÖÉÁ¥†ÔºàÊó∂Èó¥„ÄÅÊ¨¢ËøéÊ∂àÊÅØ„ÄÅAPIÊèêÁ§∫Ôºâ
                    child.remove();
                }
            });
        }

        // ÊòæÁ§∫Â∑•‰ΩúÊ±áÊä•ÂÜÖÂÆπ
        function displayWorkSummary(workSummary) {
            console.log('displayWorkSummary Ë¢´Ë∞ÉÁî®:', workSummary);

            if (!workSummary || workSummary.trim() === '') {
                console.log('Â∑•‰ΩúÊ±áÊä•ÂÜÖÂÆπ‰∏∫Á©∫');
                return;
            }

            // ÊâæÂà∞Â∑•‰ΩúÊ±áÊä•ÂÜÖÂÆπÂå∫Âüü
            const reportContent = document.getElementById('report-content');
            if (!reportContent) {
                console.error('Êâæ‰∏çÂà∞ report-content ÂÖÉÁ¥†');
                return;
            }

            // ÈöêËóèÈªòËÆ§Ê∂àÊÅØ
            const defaultMessage = document.getElementById('default-message');
            if (defaultMessage) {
                defaultMessage.style.display = 'none';
            }

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâAIÂ∑•‰ΩúÊ±áÊä•Âç°Áâá
            const existingCard = reportContent.querySelector('.ai-work-report');
            if (existingCard) {
                existingCard.remove();
            }

            // ÂàõÂª∫AIÂ∑•‰ΩúÊ±áÊä•Âç°Áâá
            const aiReportCard = document.createElement('div');
            aiReportCard.className = 'report-card ai-work-report';
            aiReportCard.innerHTML = `
                <div class="card-header">
                    <div class="card-title">
                        <span>ü§ñ</span>
                        AIÂ∑•‰ΩúÊ±áÊä•
                    </div>
                    <div class="card-subtitle">ÂàöÂàöÂÆåÊàê</div>
                </div>
                <div class="card-body">
                    <div class="work-summary-content">${workSummary.replace(/\n/g, '<br>')}</div>
                </div>
            `;

            // ÊèíÂÖ•Âà∞Áé∞ÊúâÂÜÖÂÆπ‰πãÂâç
            const firstCard = reportContent.querySelector('.report-card');
            if (firstCard) {
                reportContent.insertBefore(aiReportCard, firstCard);
            } else {
                reportContent.appendChild(aiReportCard);
            }

            console.log('AIÂ∑•‰ΩúÊ±áÊä•Âç°ÁâáÂ∑≤Ê∑ªÂä†');

            // Ê∑ªÂä†Ê†∑ÂºèÔºàÂè™Ê∑ªÂä†‰∏ÄÊ¨°Ôºâ
            if (!document.querySelector('#work-summary-styles')) {
                const style = document.createElement('style');
                style.id = 'work-summary-styles';
                style.textContent = `
                    .work-summary-content {
                        color: #cccccc;
                        line-height: 1.6;
                        font-size: 13px;
                        white-space: pre-wrap;
                        word-wrap: break-word;
                        background: #1e1e1e;
                        padding: 12px;
                        border-radius: 4px;
                        border: 1px solid #3e3e42;
                    }
                    .ai-work-report {
                        border-left: 3px solid #4ec9b0;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ÂõæÁâáÈÄâÊã©ÂØπËØùÊ°ÜÂäüËÉΩ
        function showImagePickerDialog(sessionId) {
            // ÈöêËóè‰∏ªÁïåÈù¢ÂÜÖÂÆπ
            document.querySelector('.container').style.display = 'none';

            // ÂàõÂª∫ÂõæÁâáÈÄâÊã©ÂØπËØùÊ°Ü
            const dialog = document.createElement('div');
            dialog.id = 'image-picker-dialog';
            dialog.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="
                        background: #2d2d30;
                        border: 1px solid #3e3e42;
                        border-radius: 8px;
                        padding: 24px;
                        max-width: 500px;
                        width: 90%;
                        color: #cccccc;
                    ">
                        <h2 style="margin: 0 0 16px 0; color: #ffffff; font-size: 18px;">
                            üì∑ ÈÄâÊã©ÂõæÁâá
                        </h2>
                        <p style="margin: 0 0 24px 0; color: #969696; font-size: 14px;">
                            ËØ∑ÈÄâÊã©‰∏ÄÂº†ÂõæÁâáÊñá‰ª∂ÔºåÊàñ‰ªéÂâ™Ë¥¥ÊùøÁ≤òË¥¥ÂõæÁâá
                        </p>

                        <div style="margin-bottom: 24px;">
                            <button onclick="selectImageFile('${sessionId}')" style="
                                background: #007acc;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                padding: 12px 24px;
                                margin-right: 12px;
                                cursor: pointer;
                                font-size: 14px;
                            ">üìÅ ÈÄâÊã©Êñá‰ª∂</button>

                            <button onclick="pasteImageFromClipboard('${sessionId}')" style="
                                background: #2d2d30;
                                color: #cccccc;
                                border: 1px solid #3e3e42;
                                border-radius: 4px;
                                padding: 12px 24px;
                                cursor: pointer;
                                font-size: 14px;
                            ">üìã Á≤òË¥¥ÂõæÁâá</button>
                        </div>

                        <div id="selected-image-preview" style="
                            margin-bottom: 24px;
                            text-align: center;
                            min-height: 100px;
                            border: 2px dashed #3e3e42;
                            border-radius: 4px;
                            padding: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #969696;
                        ">
                            ÊöÇÊú™ÈÄâÊã©ÂõæÁâá
                        </div>

                        <div style="text-align: right;">
                            <button onclick="cancelImagePicker()" style="
                                background: transparent;
                                color: #969696;
                                border: 1px solid #3e3e42;
                                border-radius: 4px;
                                padding: 8px 16px;
                                margin-right: 12px;
                                cursor: pointer;
                            ">ÂèñÊ∂à</button>

                            <button id="confirm-image-btn" onclick="confirmImageSelection('${sessionId}')" disabled style="
                                background: #007acc;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                padding: 8px 16px;
                                cursor: pointer;
                                opacity: 0.5;
                            ">Á°ÆËÆ§ÈÄâÊã©</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);
        }

        let selectedImageForPicker = null;

        function selectImageFile(sessionId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        selectedImageForPicker = e.target.result;
                        showImagePreview(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            };

            input.click();
        }

        function pasteImageFromClipboard(sessionId) {
            navigator.clipboard.read().then(items => {
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            item.getType(type).then(blob => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    selectedImageForPicker = e.target.result;
                                    showImagePreview(e.target.result, 'pasted-image.png');
                                };
                                reader.readAsDataURL(blob);
                            });
                            return;
                        }
                    }
                }
                alert('Ââ™Ë¥¥Êùø‰∏≠Ê≤°ÊúâÂõæÁâáÊï∞ÊçÆ');
            }).catch(err => {
                console.log('Á≤òË¥¥Â§±Ë¥•:', err);
                alert('Á≤òË¥¥ÂõæÁâáÂ§±Ë¥•ÔºåËØ∑Â∞ùËØïÈÄâÊã©Êñá‰ª∂ÊñπÂºè');
            });
        }

        function showImagePreview(dataUrl, fileName) {
            const preview = document.getElementById('selected-image-preview');
            preview.innerHTML = `
                <div>
                    <img src="${dataUrl}" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                    <div style="margin-top: 8px; font-size: 12px; color: #969696;">${fileName}</div>
                </div>
            `;

            const confirmBtn = document.getElementById('confirm-image-btn');
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
        }

        function confirmImageSelection(sessionId) {
            if (selectedImageForPicker && isConnected && socket) {
                socket.emit('pick_image_submit', {
                    pick_session_id: sessionId,
                    image_data: selectedImageForPicker
                });

                // ÊòæÁ§∫Êèê‰∫§Áä∂ÊÄÅ
                const confirmBtn = document.getElementById('confirm-image-btn');
                confirmBtn.innerHTML = 'Êèê‰∫§‰∏≠...';
                confirmBtn.disabled = true;
            }
        }

        function cancelImagePicker() {
            const dialog = document.getElementById('image-picker-dialog');
            if (dialog) {
                dialog.remove();
            }
            document.querySelector('.container').style.display = 'block';
        }
    </script>
</body>
</html>
