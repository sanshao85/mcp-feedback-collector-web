<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ MCP Feedback Collector - Webç‰ˆ</title>
    <style>
        /* VS Code é£æ ¼çš„æ·±è‰²ä¸»é¢˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            font-size: 13px;
            line-height: 1.5;
            padding: 20px;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #969696;
            margin-bottom: 24px;
        }

        /* è¿æ¥çŠ¶æ€ */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #4ec9b0;
            color: #1e1e1e;
        }

        .connection-status.disconnected {
            background: #f14c4c;
            color: white;
        }

        /* å¯¼èˆªæ ‡ç­¾ */
        .nav-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid #3e3e42;
        }

        .nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #969696;
            font-size: 13px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            color: #cccccc;
        }

        .nav-tab.active {
            color: #ffffff;
            border-bottom-color: #007acc;
        }

        /* è·å–keyé“¾æ¥ */
        .get-key-link {
            padding: 12px 20px;
            color: #007acc;
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .get-key-link:hover {
            color: #ffffff;
            text-decoration: none;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            display: none;
        }

        .content-area.active {
            display: block;
        }

        /* å·¥ä½œæ±‡æŠ¥å¡ç‰‡ */
        .report-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            background: #323233;
            border-bottom: 1px solid #3e3e42;
            color: #ffffff;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            font-size: 12px;
            color: #969696;
        }

        .card-body {
            padding: 16px 20px;
        }

        .feature-list {
            list-style: none;
        }

        .feature-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
            color: #cccccc;
        }

        .feature-item::before {
            content: 'âœ“';
            color: #4ec9b0;
            font-weight: bold;
            margin-right: 12px;
            width: 16px;
            text-align: center;
        }

        /* åé¦ˆè¡¨å•å¡ç‰‡ */
        .feedback-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            margin-top: 24px;
            overflow: hidden;
        }

        .feedback-header {
            padding: 16px 20px;
            background: #323233;
            border-bottom: 1px solid #3e3e42;
            color: #ffffff;
        }

        .feedback-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-body {
            padding: 20px;
        }

        /* è¡¨å•å…ƒç´  */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #969696;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background: #1e1e1e;
            color: #cccccc;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #007acc;
        }

        .form-textarea::placeholder {
            color: #6a6a6a;
        }

        /* å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
        .image-preview-area {
            margin-bottom: 16px;
        }

        .image-previews {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .image-preview {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 4px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            overflow: hidden;
        }

        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e81123;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background: #2d2d30;
            color: #cccccc;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toolbar-btn:hover {
            background: #3c3c3c;
            border-color: #007acc;
        }

        /* æŒ‰é’®ç»„ */
        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            border: none;
        }

        .btn-secondary {
            background: transparent;
            color: #969696;
            border: 1px solid #3e3e42;
        }

        .btn-secondary:hover {
            background: #3c3c3c;
        }

        .btn-primary {
            background: #007acc;
            color: white;
            border: 1px solid #007acc;
        }

        .btn-primary:hover {
            background: #005a9e;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* çŠ¶æ€æ¶ˆæ¯ */
        .status-message {
            padding: 12px;
            border-radius: 4px;
            margin: 16px 0;
            font-size: 13px;
        }

        .status-message.success {
            background: #4ec9b0;
            color: #1e1e1e;
        }

        .status-message.error {
            background: #f14c4c;
            color: white;
        }

        .status-message.info {
            background: #007acc;
            color: white;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #3e3e42;
            border-radius: 50%;
            border-top-color: #007acc;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* èŠå¤©ç•Œé¢æ ·å¼ */
        .chat-container {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 16px 20px;
            background: #323233;
            border-bottom: 1px solid #3e3e42;
            color: #ffffff;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            display: flex;
            margin-bottom: 16px;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: #007acc;
            color: white;
        }

        .message.ai .message-bubble {
            background: #323233;
            color: #cccccc;
            border: 1px solid #3e3e42;
        }

        .message-time {
            text-align: center;
            color: #969696;
            font-size: 12px;
            margin: 16px 0 8px;
        }

        .api-hint {
            background: #323233;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .api-hint-title {
            color: #4ec9b0;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .api-hint-link {
            color: #007acc;
            text-decoration: none;
        }

        .api-hint-desc {
            font-size: 12px;
            color: #969696;
            margin-top: 4px;
        }

        .chat-input-area {
            background: #323233;
            border-top: 1px solid #3e3e42;
            padding: 12px;
        }

        .chat-input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            min-height: 32px;
            max-height: 80px;
            padding: 6px 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background: #1e1e1e;
            color: #cccccc;
            resize: none;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.4;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .chat-actions {
            display: flex;
            gap: 4px;
        }

        .chat-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: 1px solid #3e3e42;
            background: #2d2d30;
            color: #cccccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .chat-btn:hover {
            background: #3c3c3c;
            border-color: #007acc;
        }

        .send-btn {
            background: #007acc !important;
            border-color: #007acc !important;
            color: white !important;
        }

        .send-btn:hover {
            background: #005a9e !important;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 14px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 7px;
            border: 3px solid #1e1e1e;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .page-title {
                font-size: 20px;
            }

            .card-header, .feedback-header {
                padding: 12px 16px;
            }

            .card-body, .feedback-body {
                padding: 16px;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¿æ¥çŠ¶æ€ -->
        <div id="connection-status" class="connection-status disconnected">
            è¿æ¥ä¸­...
        </div>

        <!-- é¡µé¢æ ‡é¢˜ -->
        <h1 class="page-title">
            <span>ğŸ¯</span>
            MCP Feedback Collector - Webç‰ˆ
        </h1>
        <p class="page-subtitle">åŸºäºFlask + WebSocketçš„ç°ä»£åŒ–åé¦ˆæ”¶é›†å™¨</p>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('report')">ğŸ“‹ å·¥ä½œæ±‡æŠ¥</button>
            <button class="nav-tab" onclick="switchTab('chat')">ğŸ’¬ AIå¯¹è¯</button>
            <a href="https://api.ssopen.top" target="_blank" class="get-key-link">ğŸ”‘ è·å–key</a>
        </div>

        <!-- çŠ¶æ€æ¶ˆæ¯åŒºåŸŸ -->
        <div id="status-messages"></div>

        <!-- å·¥ä½œæ±‡æŠ¥å†…å®¹åŒºåŸŸ -->
        <div id="report-content" class="content-area active">
            <!-- åŠ¨æ€å·¥ä½œæ±‡æŠ¥å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            <div id="default-message" class="report-card" style="text-align: center; padding: 40px;">
                <div class="card-body">
                    <div style="color: #969696; font-size: 14px;">
                        <span style="font-size: 24px;">ğŸ“‹</span>
                        <br><br>
                        ç­‰å¾…AIå·¥ä½œæ±‡æŠ¥...
                        <br><br>
                        <small>å½“AIè°ƒç”¨ collect_feedback() æ—¶ï¼Œå·¥ä½œæ±‡æŠ¥å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</small>
                    </div>
                </div>
            </div>

            <!-- åé¦ˆè¡¨å• -->
            <div class="feedback-card">
                <div class="feedback-header">
                    <div class="feedback-title">
                        <span>ğŸ’¬</span>
                        æ‚¨çš„åé¦ˆ
                    </div>
                </div>
                <div class="feedback-body">
                    <form id="feedback-form">
                        <div class="form-group">
                            <label class="form-label">åé¦ˆå†…å®¹</label>
                            <textarea
                                id="feedback-text"
                                class="form-textarea"
                                placeholder="è¯·è¾“å…¥æ‚¨å¯¹æœ¬æ¬¡å·¥ä½œçš„åé¦ˆå’Œå»ºè®®..."
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">é™„ä»¶å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                            <div class="toolbar">
                                <button type="button" class="toolbar-btn" onclick="selectImages()">
                                    ğŸ“ é€‰æ‹©å›¾ç‰‡
                                </button>
                                <button type="button" class="toolbar-btn" onclick="pasteImages()">
                                    ğŸ“‹ ç²˜è´´å›¾ç‰‡
                                </button>
                            </div>

                            <div class="image-preview-area">
                                <div class="image-previews" id="image-previews"></div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="clearFeedbackForm()">
                                æ¸…ç©º
                            </button>
                            <button type="submit" class="btn btn-primary" id="submit-feedback-btn">
                                æäº¤åé¦ˆ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- AIå¯¹è¯å†…å®¹åŒºåŸŸ -->
        <div id="chat-content" class="content-area">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">
                        <span>ğŸ’¬</span>
                        AI åŠ©æ‰‹å¯¹è¯
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="message-time">ä»Šå¤©</div>

                    <div class="message ai">
                        <div class="message-bubble">æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</div>
                    </div>

                    {% if not api_key_configured %}
                    <div class="api-hint">
                        <div class="api-hint-title">ğŸ”‘ éœ€è¦APIå¯†é’¥</div>
                        <div>
                            <a href="https://api.ssopen.top/" target="_blank" class="api-hint-link">
                                ç‚¹å‡»è·å– SSOpen API å¯†é’¥
                            </a>
                        </div>
                        <div class="api-hint-desc">é«˜é€Ÿç¨³å®š | ä»·æ ¼ä¼˜æƒ  | å®‰å…¨å¯é </div>
                    </div>
                    {% endif %}
                </div>

                <div class="chat-input-area">
                    <!-- èŠå¤©å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                    <div id="chat-image-previews" class="image-previews-container" style="display: none;">
                        <div class="image-previews" id="chat-image-previews-content"></div>
                    </div>

                    <div class="chat-input-row">
                        <textarea id="chat-input" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="handleChatKeydown(event)"></textarea>
                        <div class="chat-actions">
                            <button class="chat-btn" onclick="selectChatImage()" title="é€‰æ‹©å›¾ç‰‡">ğŸ“·</button>
                            <button class="chat-btn" onclick="pasteChatImage()" title="ç²˜è´´å›¾ç‰‡">ğŸ“‹</button>
                            <button class="chat-btn" onclick="clearChat()" title="æ¸…ç©ºèŠå¤©">ğŸ—‘ï¸</button>
                            <button class="chat-btn send-btn" onclick="sendChatMessage()" title="å‘é€" id="send-chat-btn">ğŸš€</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IOå®¢æˆ·ç«¯ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- ä¸»åº”ç”¨è„šæœ¬ -->
    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let currentTab = 'report';
        let selectedImages = [];
        let chatImages = [];
        let isConnected = false;
        let currentFeedbackSession = null;

        // AIèŠå¤©ç›¸å…³å˜é‡
        let chatConfig = null;
        let chatHistory = [];
        let currentAIMessage = null;
        let currentAIContent = '';
        let isApiCalling = false;

        // è·å–APIé…ç½®
        async function loadChatConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    chatConfig = await response.json();
                    console.log('èŠå¤©é…ç½®åŠ è½½æˆåŠŸ:', chatConfig);
                    return true;
                } else {
                    console.error('è·å–é…ç½®å¤±è´¥:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®æ—¶å‡ºé”™:', error);
                return false;
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½èŠå¤©é…ç½®
            loadChatConfig();

            initializeSocket();

            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const session = urlParams.get('session');

            console.log('URLå‚æ•°:', { mode, session });

            if (mode === 'chat') {
                switchTab('chat');
            } else if (mode === 'feedback' && session) {
                // åé¦ˆæ¨¡å¼ï¼Œè®¾ç½®ä¼šè¯IDå¹¶è·å–å·¥ä½œæ±‡æŠ¥
                currentFeedbackSession = session;
                console.log('è®¾ç½®åé¦ˆä¼šè¯ID:', session);

                // ç­‰å¾…WebSocketè¿æ¥å»ºç«‹åè·å–å·¥ä½œæ±‡æŠ¥
                setTimeout(() => {
                    if (isConnected && socket) {
                        console.log('è¯·æ±‚å·¥ä½œæ±‡æŠ¥æ•°æ®...');
                        socket.emit('get_work_summary', { feedback_session_id: session });
                    } else {
                        console.log('WebSocketæœªè¿æ¥ï¼Œç¨åé‡è¯•...');
                        setTimeout(() => {
                            if (isConnected && socket) {
                                socket.emit('get_work_summary', { feedback_session_id: session });
                            }
                        }, 1000);
                    }
                }, 500);
            } else if (mode === 'pick_image' && session) {
                // å›¾ç‰‡é€‰æ‹©æ¨¡å¼
                showImagePickerDialog(session);
            }
        });

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                isConnected = true;
                updateConnectionStatus('connected', 'å·²è¿æ¥');
                console.log('WebSocketè¿æ¥æˆåŠŸ');
            });
            
            socket.on('disconnect', function() {
                isConnected = false;
                updateConnectionStatus('disconnected', 'è¿æ¥æ–­å¼€');
                console.log('WebSocketè¿æ¥æ–­å¼€');
            });
            
            socket.on('feedback_session_started', function(data) {
                console.log('åé¦ˆä¼šè¯å·²å¼€å§‹:', data);
            });
            
            socket.on('feedback_submitted', function(data) {
                showStatusMessage('success', 'åé¦ˆæäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å®è´µæ„è§ã€‚');
                clearFeedbackForm();
            });
            
            socket.on('feedback_error', function(data) {
                showStatusMessage('error', data.error);
            });
            
            // èŠå¤©åŠŸèƒ½å·²æ”¹ä¸ºç›´æ¥APIè°ƒç”¨ï¼Œä¸å†éœ€è¦WebSocketäº‹ä»¶

            socket.on('work_summary_data', function(data) {
                console.log('æ”¶åˆ°å·¥ä½œæ±‡æŠ¥æ•°æ®:', data);
                if (data.work_summary) {
                    displayWorkSummary(data.work_summary);
                }
            });

            socket.on('pick_image_success', function(data) {
                console.log('å›¾ç‰‡é€‰æ‹©æˆåŠŸ:', data);
                showStatusMessage('success', data.message);

                // å…³é—­å›¾ç‰‡é€‰æ‹©å¯¹è¯æ¡†
                setTimeout(() => {
                    cancelImagePicker();
                }, 1000);
            });

            socket.on('pick_image_error', function(data) {
                console.log('å›¾ç‰‡é€‰æ‹©å¤±è´¥:', data);
                showStatusMessage('error', data.error);

                // é‡æ–°å¯ç”¨ç¡®è®¤æŒ‰é’®
                const confirmBtn = document.getElementById('confirm-image-btn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = 'ç¡®è®¤é€‰æ‹©';
                    confirmBtn.disabled = false;
                }
            });
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `connection-status ${status}`;
            statusEl.textContent = text;
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatusMessage(type, message) {
            const container = document.getElementById('status-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `status-message ${type}`;
            messageEl.textContent = message;
            
            container.appendChild(messageEl);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 3000);
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            currentTab = tabName;

            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ‰¾åˆ°å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®å¹¶æ¿€æ´»
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                if ((tabName === 'report' && tab.textContent.includes('å·¥ä½œæ±‡æŠ¥')) ||
                    (tabName === 'chat' && tab.textContent.includes('AIå¯¹è¯'))) {
                    tab.classList.add('active');
                }
            });

            // æ›´æ–°å†…å®¹åŒºåŸŸæ˜¾ç¤º
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });
            document.getElementById(tabName + '-content').classList.add('active');

            // æ ¹æ®æ ‡ç­¾åˆå§‹åŒ–ç›¸åº”åŠŸèƒ½
            if (tabName === 'chat') {
                // èŠå¤©æ ‡ç­¾å·²åˆ‡æ¢ä¸ºç›´æ¥APIè°ƒç”¨ï¼Œæ— éœ€WebSocketåˆå§‹åŒ–
                console.log('åˆ‡æ¢åˆ°èŠå¤©æ ‡ç­¾');
            }
        }

        // åé¦ˆè¡¨å•ç›¸å…³åŠŸèƒ½
        function selectImages() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;

            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        addImage(file);
                    }
                });
            };

            input.click();
        }

        function pasteImages() {
            navigator.clipboard.read().then(items => {
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            item.getType(type).then(blob => {
                                const file = new File([blob], `pasted-image-${Date.now()}.png`, { type: blob.type });
                                addImage(file);
                            });
                        }
                    }
                }
            }).catch(err => {
                console.log('ç²˜è´´å¤±è´¥:', err);
                showStatusMessage('error', 'ç²˜è´´å›¾ç‰‡å¤±è´¥ï¼Œè¯·å°è¯•é€‰æ‹©æ–‡ä»¶æ–¹å¼');
            });
        }

        function addImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    file: file,
                    data: e.target.result,
                    name: file.name,
                    id: Date.now() + Math.random()
                };

                selectedImages.push(imageData);
                updateImagePreviews();
            };
            reader.readAsDataURL(file);
        }

        function updateImagePreviews() {
            const container = document.getElementById('image-previews');
            container.innerHTML = '';

            selectedImages.forEach((image, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                previewDiv.innerHTML = `
                    <img src="${image.data}" alt="${image.name}" class="preview-img">
                    <button type="button" class="remove-btn" onclick="removeImage(${index})">Ã—</button>
                `;
                container.appendChild(previewDiv);
            });
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreviews();
        }

        function clearFeedbackForm() {
            document.getElementById('feedback-text').value = '';
            selectedImages = [];
            updateImagePreviews();
        }

        // æäº¤åé¦ˆ
        document.getElementById('feedback-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const feedbackText = document.getElementById('feedback-text').value.trim();

            console.log('æäº¤åé¦ˆ:', {
                text: feedbackText,
                images: selectedImages.length,
                session: currentFeedbackSession,
                connected: isConnected
            });

            if (!feedbackText && selectedImages.length === 0) {
                showStatusMessage('error', 'è¯·è¾“å…¥åé¦ˆå†…å®¹æˆ–é€‰æ‹©å›¾ç‰‡');
                return;
            }

            if (!isConnected) {
                showStatusMessage('error', 'è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // ç¦ç”¨æäº¤æŒ‰é’®
            const submitBtn = document.getElementById('submit-feedback-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> æäº¤ä¸­...';

            // å‘é€åé¦ˆæ•°æ®
            const feedbackData = {
                text: feedbackText,
                images: selectedImages.map(img => ({
                    name: img.name,
                    data: img.data
                })),
                feedback_session_id: currentFeedbackSession
            };

            console.log('å‘é€åé¦ˆæ•°æ®:', feedbackData);
            socket.emit('submit_feedback', feedbackData);

            // 5ç§’åé‡æ–°å¯ç”¨æŒ‰é’®ï¼ˆé˜²æ­¢å¡ä½ï¼‰
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'æäº¤åé¦ˆ';
            }, 5000);
        });

        // èŠå¤©ç›¸å…³åŠŸèƒ½
        function selectChatImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;

            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        addChatImage(file);
                    }
                });
            };

            input.click();
        }

        function pasteChatImage() {
            navigator.clipboard.read().then(items => {
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            item.getType(type).then(blob => {
                                const file = new File([blob], `pasted-image-${Date.now()}.png`, { type: blob.type });
                                addChatImage(file);
                            });
                        }
                    }
                }
            }).catch(err => {
                console.log('ç²˜è´´å¤±è´¥:', err);
                showStatusMessage('error', 'ç²˜è´´å›¾ç‰‡å¤±è´¥ï¼Œè¯·å°è¯•é€‰æ‹©æ–‡ä»¶æ–¹å¼');
            });
        }

        function addChatImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    file: file,
                    data: e.target.result,
                    name: file.name,
                    id: Date.now() + Math.random()
                };
                chatImages.push(imageData);
                updateChatImagePreviews();
                showStatusMessage('info', `å·²æ·»åŠ å›¾ç‰‡: ${file.name}`);
            };
            reader.readAsDataURL(file);
        }

        function updateChatImagePreviews() {
            const container = document.getElementById('chat-image-previews-content');
            const previewArea = document.getElementById('chat-image-previews');

            if (!container || !previewArea) return;

            container.innerHTML = '';

            if (chatImages.length === 0) {
                previewArea.style.display = 'none';
                return;
            }

            previewArea.style.display = 'block';

            chatImages.forEach((image, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                previewDiv.innerHTML = `
                    <img src="${image.data}" alt="${image.name}" class="preview-img">
                    <button type="button" class="remove-btn" onclick="removeChatImage(${index})">Ã—</button>
                `;
                container.appendChild(previewDiv);
            });
        }

        function removeChatImage(index) {
            chatImages.splice(index, 1);
            updateChatImagePreviews();
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const messageText = input ? input.value.trim() : '';

            if (!messageText && chatImages.length === 0) {
                return;
            }

            // æ£€æŸ¥é…ç½®
            if (!chatConfig || !chatConfig.api_key) {
                showStatusMessage('error', 'APIé…ç½®æœªåŠ è½½æˆ–APIå¯†é’¥æœªè®¾ç½®');
                return;
            }

            if (isApiCalling) {
                showStatusMessage('warning', 'æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessageToChat('user', messageText, chatImages);

            // æ¸…ç©ºè¾“å…¥
            if (input) input.value = '';
            const currentImages = chatImages.slice();
            chatImages = [];
            updateChatImagePreviews();

            // ç¦ç”¨å‘é€æŒ‰é’®
            const sendBtn = document.getElementById('send-chat-btn');
            sendBtn.disabled = true;
            isApiCalling = true;

            // å‡†å¤‡æ¥æ”¶AIå›å¤
            currentAIContent = '';
            currentAIMessage = addMessageToChat('ai', '', []);

            try {
                await callChatAPI(messageText, currentImages);
            } catch (error) {
                console.error('èŠå¤©APIè°ƒç”¨å¤±è´¥:', error);
                showStatusMessage('error', `èŠå¤©å¤±è´¥: ${error.message}`);
            } finally {
                // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
                sendBtn.disabled = false;
                isApiCalling = false;
            }
        }

        // ç›´æ¥è°ƒç”¨èŠå¤©API
        async function callChatAPI(messageText, images) {
            // æ„å»ºæ¶ˆæ¯æ ¼å¼
            const userMessage = buildAPIMessage(messageText, images);

            // æ·»åŠ åˆ°èŠå¤©å†å²
            chatHistory.push(userMessage);

            // æ„å»ºAPIè¯·æ±‚
            const requestBody = {
                model: chatConfig.model,
                messages: chatHistory,
                stream: true,
                temperature: chatConfig.temperature || 0.7,
                max_tokens: chatConfig.max_tokens || 2000
            };

            console.log('å‘é€APIè¯·æ±‚:', {
                url: `${chatConfig.api_base_url}/v1/chat/completions`,
                model: requestBody.model,
                messageCount: requestBody.messages.length
            });

            const response = await fetch(`${chatConfig.api_base_url}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${chatConfig.api_key}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
            }

            // å¤„ç†æµå¼å“åº”
            await handleStreamResponse(response);
        }

        // æ„å»ºAPIæ¶ˆæ¯æ ¼å¼
        function buildAPIMessage(messageText, images) {
            if (!images || images.length === 0) {
                // çº¯æ–‡æœ¬æ¶ˆæ¯
                return { role: "user", content: messageText };
            } else {
                // åŒ…å«å›¾ç‰‡çš„æ¶ˆæ¯
                const content = [];

                if (messageText) {
                    content.push({ type: "text", text: messageText });
                }

                images.forEach(img => {
                    let imageData = img.data;
                    // ç¡®ä¿æ˜¯å®Œæ•´çš„data URLæ ¼å¼
                    if (!imageData.startsWith('data:image/')) {
                        imageData = `data:image/png;base64,${imageData}`;
                    }

                    content.push({
                        type: "image_url",
                        image_url: { url: imageData }
                    });
                });

                return { role: "user", content: content };
            }
        }

        // å¤„ç†æµå¼å“åº”
        async function handleStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let aiResponseContent = '';

            try {
                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '') continue;

                        if (line.startsWith('data: ')) {
                            const data = line.slice(6); // ç§»é™¤ 'data: ' å‰ç¼€

                            if (data === '[DONE]') {
                                // æµå¼å“åº”ç»“æŸ
                                if (aiResponseContent) {
                                    // å°†AIå›å¤æ·»åŠ åˆ°èŠå¤©å†å²
                                    chatHistory.push({
                                        role: "assistant",
                                        content: aiResponseContent
                                    });
                                }
                                console.log('AIå›å¤å®Œæˆï¼Œæ€»é•¿åº¦:', aiResponseContent.length);
                                return;
                            }

                            try {
                                const jsonData = JSON.parse(data);
                                if (jsonData.choices && jsonData.choices[0]) {
                                    const delta = jsonData.choices[0].delta;
                                    if (delta && delta.content) {
                                        aiResponseContent += delta.content;

                                        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                                        if (currentAIMessage) {
                                            currentAIMessage.innerHTML = aiResponseContent;

                                            // æ»šåŠ¨åˆ°åº•éƒ¨
                                            const chatMessages = document.getElementById('chat-messages');
                                            chatMessages.scrollTop = chatMessages.scrollHeight;
                                        }
                                    }
                                }
                            } catch (e) {
                                // å¿½ç•¥JSONè§£æé”™è¯¯
                                console.log('JSONè§£æé”™è¯¯:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('å¤„ç†æµå¼å“åº”æ—¶å‡ºé”™:', error);
                throw error;
            } finally {
                reader.releaseLock();
            }
        }

        function addMessageToChat(sender, text, images) {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return null;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            let imageHtml = '';
            if (images && images.length > 0) {
                imageHtml = images.map(img =>
                    `<img src="${img.data}" style="max-width: 200px; max-height: 200px; border-radius: 4px; margin: 4px 0; display: block;">`
                ).join('');
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.innerHTML = `${imageHtml}${text}`;

            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return bubbleDiv; // è¿”å›æ°”æ³¡å…ƒç´ ï¼Œç”¨äºæ›´æ–°AIæ¶ˆæ¯
        }

        // handleChatMessageChunkå‡½æ•°å·²ç§»é™¤ï¼Œæ”¹ä¸ºç›´æ¥APIè°ƒç”¨å¤„ç†æµå¼å“åº”

        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
                // æ¸…ç©ºèŠå¤©å†å²
                chatHistory = [];

                // æ¸…ç©ºç•Œé¢æ˜¾ç¤º
                clearChatMessages();

                showStatusMessage('info', 'èŠå¤©è®°å½•å·²æ¸…ç©º');
            }
        }

        function clearChatMessages() {
            const chatMessages = document.getElementById('chat-messages');
            // ä¿ç•™æ¬¢è¿æ¶ˆæ¯å’ŒAPIæç¤º
            const children = Array.from(chatMessages.children);
            children.forEach((child, index) => {
                if (index > 2) { // ä¿ç•™å‰3ä¸ªå…ƒç´ ï¼ˆæ—¶é—´ã€æ¬¢è¿æ¶ˆæ¯ã€APIæç¤ºï¼‰
                    child.remove();
                }
            });
        }

        // æ˜¾ç¤ºå·¥ä½œæ±‡æŠ¥å†…å®¹
        function displayWorkSummary(workSummary) {
            console.log('displayWorkSummary è¢«è°ƒç”¨:', workSummary);

            if (!workSummary || workSummary.trim() === '') {
                console.log('å·¥ä½œæ±‡æŠ¥å†…å®¹ä¸ºç©º');
                return;
            }

            // æ‰¾åˆ°å·¥ä½œæ±‡æŠ¥å†…å®¹åŒºåŸŸ
            const reportContent = document.getElementById('report-content');
            if (!reportContent) {
                console.error('æ‰¾ä¸åˆ° report-content å…ƒç´ ');
                return;
            }

            // éšè—é»˜è®¤æ¶ˆæ¯
            const defaultMessage = document.getElementById('default-message');
            if (defaultMessage) {
                defaultMessage.style.display = 'none';
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰AIå·¥ä½œæ±‡æŠ¥å¡ç‰‡
            const existingCard = reportContent.querySelector('.ai-work-report');
            if (existingCard) {
                existingCard.remove();
            }

            // åˆ›å»ºAIå·¥ä½œæ±‡æŠ¥å¡ç‰‡
            const aiReportCard = document.createElement('div');
            aiReportCard.className = 'report-card ai-work-report';
            aiReportCard.innerHTML = `
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ¤–</span>
                        AIå·¥ä½œæ±‡æŠ¥
                    </div>
                    <div class="card-subtitle">åˆšåˆšå®Œæˆ</div>
                </div>
                <div class="card-body">
                    <div class="work-summary-content">${workSummary.replace(/\n/g, '<br>')}</div>
                </div>
            `;

            // æ’å…¥åˆ°ç°æœ‰å†…å®¹ä¹‹å‰
            const firstCard = reportContent.querySelector('.report-card');
            if (firstCard) {
                reportContent.insertBefore(aiReportCard, firstCard);
            } else {
                reportContent.appendChild(aiReportCard);
            }

            console.log('AIå·¥ä½œæ±‡æŠ¥å¡ç‰‡å·²æ·»åŠ ');

            // æ·»åŠ æ ·å¼ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
            if (!document.querySelector('#work-summary-styles')) {
                const style = document.createElement('style');
                style.id = 'work-summary-styles';
                style.textContent = `
                    .work-summary-content {
                        color: #cccccc;
                        line-height: 1.6;
                        font-size: 13px;
                        white-space: pre-wrap;
                        word-wrap: break-word;
                        background: #1e1e1e;
                        padding: 12px;
                        border-radius: 4px;
                        border: 1px solid #3e3e42;
                    }
                    .ai-work-report {
                        border-left: 3px solid #4ec9b0;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // å›¾ç‰‡é€‰æ‹©å¯¹è¯æ¡†åŠŸèƒ½
        function showImagePickerDialog(sessionId) {
            // éšè—ä¸»ç•Œé¢å†…å®¹
            document.querySelector('.container').style.display = 'none';

            // åˆ›å»ºå›¾ç‰‡é€‰æ‹©å¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.id = 'image-picker-dialog';
            dialog.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="
                        background: #2d2d30;
                        border: 1px solid #3e3e42;
                        border-radius: 8px;
                        padding: 24px;
                        max-width: 500px;
                        width: 90%;
                        color: #cccccc;
                    ">
                        <h2 style="margin: 0 0 16px 0; color: #ffffff; font-size: 18px;">
                            ğŸ“· é€‰æ‹©å›¾ç‰‡
                        </h2>
                        <p style="margin: 0 0 24px 0; color: #969696; font-size: 14px;">
                            è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡æ–‡ä»¶ï¼Œæˆ–ä»å‰ªè´´æ¿ç²˜è´´å›¾ç‰‡
                        </p>

                        <div style="margin-bottom: 24px;">
                            <button onclick="selectImageFile('${sessionId}')" style="
                                background: #007acc;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                padding: 12px 24px;
                                margin-right: 12px;
                                cursor: pointer;
                                font-size: 14px;
                            ">ğŸ“ é€‰æ‹©æ–‡ä»¶</button>

                            <button onclick="pasteImageFromClipboard('${sessionId}')" style="
                                background: #2d2d30;
                                color: #cccccc;
                                border: 1px solid #3e3e42;
                                border-radius: 4px;
                                padding: 12px 24px;
                                cursor: pointer;
                                font-size: 14px;
                            ">ğŸ“‹ ç²˜è´´å›¾ç‰‡</button>
                        </div>

                        <div id="selected-image-preview" style="
                            margin-bottom: 24px;
                            text-align: center;
                            min-height: 100px;
                            border: 2px dashed #3e3e42;
                            border-radius: 4px;
                            padding: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #969696;
                        ">
                            æš‚æœªé€‰æ‹©å›¾ç‰‡
                        </div>

                        <div style="text-align: right;">
                            <button onclick="cancelImagePicker()" style="
                                background: transparent;
                                color: #969696;
                                border: 1px solid #3e3e42;
                                border-radius: 4px;
                                padding: 8px 16px;
                                margin-right: 12px;
                                cursor: pointer;
                            ">å–æ¶ˆ</button>

                            <button id="confirm-image-btn" onclick="confirmImageSelection('${sessionId}')" disabled style="
                                background: #007acc;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                padding: 8px 16px;
                                cursor: pointer;
                                opacity: 0.5;
                            ">ç¡®è®¤é€‰æ‹©</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);
        }

        let selectedImageForPicker = null;

        function selectImageFile(sessionId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        selectedImageForPicker = e.target.result;
                        showImagePreview(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            };

            input.click();
        }

        function pasteImageFromClipboard(sessionId) {
            navigator.clipboard.read().then(items => {
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            item.getType(type).then(blob => {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    selectedImageForPicker = e.target.result;
                                    showImagePreview(e.target.result, 'pasted-image.png');
                                };
                                reader.readAsDataURL(blob);
                            });
                            return;
                        }
                    }
                }
                alert('å‰ªè´´æ¿ä¸­æ²¡æœ‰å›¾ç‰‡æ•°æ®');
            }).catch(err => {
                console.log('ç²˜è´´å¤±è´¥:', err);
                alert('ç²˜è´´å›¾ç‰‡å¤±è´¥ï¼Œè¯·å°è¯•é€‰æ‹©æ–‡ä»¶æ–¹å¼');
            });
        }

        function showImagePreview(dataUrl, fileName) {
            const preview = document.getElementById('selected-image-preview');
            preview.innerHTML = `
                <div>
                    <img src="${dataUrl}" style="max-width: 200px; max-height: 150px; border-radius: 4px;">
                    <div style="margin-top: 8px; font-size: 12px; color: #969696;">${fileName}</div>
                </div>
            `;

            const confirmBtn = document.getElementById('confirm-image-btn');
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
        }

        function confirmImageSelection(sessionId) {
            if (selectedImageForPicker && isConnected && socket) {
                socket.emit('pick_image_submit', {
                    pick_session_id: sessionId,
                    image_data: selectedImageForPicker
                });

                // æ˜¾ç¤ºæäº¤çŠ¶æ€
                const confirmBtn = document.getElementById('confirm-image-btn');
                confirmBtn.innerHTML = 'æäº¤ä¸­...';
                confirmBtn.disabled = true;
            }
        }

        function cancelImagePicker() {
            const dialog = document.getElementById('image-picker-dialog');
            if (dialog) {
                dialog.remove();
            }
            document.querySelector('.container').style.display = 'block';
        }
    </script>
</body>
</html>
